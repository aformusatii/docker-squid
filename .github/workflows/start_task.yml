name: Start Task Definition on AWS ECS

on:
  workflow_dispatch:  # This event allows manual triggering
  
env:
  AWS_REGION: us-east-1
  AWS_CLUSTER_NAME: TestClusterV1
  AWS_TASK_DEF: SQUID_HTTP_PROXY_V2
  AWS_SEC_GROUP: sg-0b1d5a16a78fb33e8
  
# https://docs.github.com/en/actions/deployment/deploying-to-your-cloud-provider/deploying-to-amazon-elastic-container-service

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Run Task Definition on ECS Cluster
      run: |
        vpc_id=$(aws ec2 describe-vpcs --region us-east-1 --query "Vpcs[0].VpcId" --output text)
        subnet_ids=$(aws ec2 describe-subnets --region us-east-1 --query "Subnets[?VpcId=='$vpc_id'].SubnetId" --output text)
        
        subnet_ids=$(echo $subnet_ids | sed 's/ /","/g')
        subnet_ids="\"$subnet_ids\""
        
        network_config="awsvpcConfiguration={subnets=[$subnet_ids],securityGroups=[\"$AWS_SEC_GROUP\"],assignPublicIp=\"ENABLED\"}"
        
        echo $vpc_id
        echo $network_config
        
        aws ecs run-task \
            --cluster "$AWS_CLUSTER_NAME" \
            --task-definition "$AWS_TASK_DEF" \
            --launch-type FARGATE \
            --count 1 \
            --network-configuration "$network_config" \
            --output text
